function e = runAlg(object, alg, algType, varargin)
    %% Loads optim package for octave
    Utilities.loadPkgOptimInOctave();
    %% Load object
    load(Utilities.getObjBinFilePath(Utilities.joinText(object, '.mat')));
    c = Constants();

    %% Trajectory
    trajectoryGetterFunc = getTrajectory(object);
    [Yzad, kk, ypp, upp, xpp] = trajectoryGetterFunc();

    %% Check for plotting being turned off
    if length(varargin) >= 1
        isPlotting = varargin{1};
    else
        isPlotting = true;
    end

    %% Test loop
    if strcmp(func2str(alg), c.algDMC)...
        || strcmp(func2str(alg), c.algGPC)...
        || strcmp(func2str(alg), c.algMPCS)
        e = runSingleAlg(D, N, Nu, mi, lambda, uMin, uMax, duMin, duMax,...
        yMin, yMax, alg, algType, ny, nu, nx, st, A, B, dA, dB, dC, dD, xpp,...
        ypp, upp, Yzad, kk, isPlotting);
    else
        disp(Utilities.joinText('Unknown algorithm : ', func2str(alg)));
    end
end

function e = runSingleAlg(D, N, Nu, mi, lambda, uMin, uMax, duMin, duMax,...
    yMin, yMax, alg, algType, ny, nu, nx, st, A, B, dA, dB, dC, dD, xpp, ypp,...
    upp, Yzad, kk, isPlotting)

    % Get D elements of object step response
    stepResponses = getStepResponsesEq(ny, nu, A, B, D);

    %% Variable initialisation
    XX = zeros(kk, nx);    
    YY = zeros(kk, ny);
    UU = zeros(kk, nu);

    %% Regulator
    reg = getRegulatorObject(D, N, Nu, ny, nu, nx, stepResponses, A, B,...
        dA, dB, dC, dD, mi, lambda, uMin, uMax, duMin, duMax, yMin, yMax,...
        alg, algType);

    for k=1:kk
        if strcmp(func2str(alg), func2str(@MPCS))
            [XX(k, :), YY(k, :)]= getObjectOutputState(dA, dB, dC, dD,...
                XX, xpp, nx, UU, upp, nu, ny, k);
            reg = reg.calculateControl(XX(k, :), Yzad(k, :));
        else
            YY(k, :) = getObjectOutputEq(A, B, YY, ypp, UU, upp, ny, nu, k);
            reg = reg.calculateControl(YY(k, :), Yzad(k, :));
        end
        UU(k, :) = reg.getControl();
    end
    if isPlotting
        algName = func2str(alg);
        plotRun(YY, Yzad, UU, st, ny, nu, algName, algType);
    end
    e = Utilities.calculateError(YY, Yzad)
end

function reg = getRegulatorObject(D, N, Nu, ny, nu, nx, stepResponses, A, B,...
        dA, dB, dC, dD, mi, lambda, uMin, uMax, duMin, duMax, yMin, yMax,...
        alg, algType)
    c = Constants();
    % DMC
    if strcmp(func2str(alg), func2str(@DMC))
        if strcmp(algType, c.numericalAlgType)
            reg = alg(D, N, Nu, ny, nu, stepResponses,...
                'mi', mi, 'lambda', lambda,...
                'uMin', uMin, 'uMax', uMax,...
                'duMin', duMin, 'duMax', duMax,...
                'yMin', yMin, 'yMax', yMax,...
                'algType', algType);
        else
            reg = alg(D, N, Nu, ny, nu, stepResponses,...
                'mi', mi, 'lambda', lambda,...
                'uMin', uMin, 'uMax', uMax,...
                'duMin', duMin, 'duMax', duMax,...
                'algType', algType);
        end
    % GPC
    elseif strcmp(func2str(alg), func2str(@GPC))
        if strcmp(algType, c.numericalAlgType)
            reg = alg(D, N, Nu, ny, nu, A, B,...
                'mi', mi, 'lambda', lambda,...
                'uMin', uMin, 'uMax', uMax,...
                'duMin', duMin, 'duMax', duMax,...
                'yMin', yMin, 'yMax', yMax,...
                'algType', algType);
        else
            reg = alg(D, N, Nu, ny, nu, A, B,...
                'mi', mi, 'lambda', lambda,...
                'uMin', uMin, 'uMax', uMax,...
                'duMin', duMin, 'duMax', duMax,...
                'algType', algType);
        end
    % MPCS
    elseif strcmp(func2str(alg), func2str(@MPCS))
        if strcmp(algType, c.numericalAlgType)
            reg = alg(N, Nu, ny, nu, nx, dA, dB, dC, dD,...
                'mi', mi, 'lambda', lambda,...
                'uMin', uMin, 'uMax', uMax,...
                'duMin', duMin, 'duMax', duMax,...
                'yMin', yMin, 'yMax', yMax,...
                'algType', algType);
        else
            reg = alg(N, Nu, ny, nu, nx, dA, dB, dC, dD,...
                'mi', mi, 'lambda', lambda,...
                'uMin', uMin, 'uMax', uMax,...
                'duMin', duMin, 'duMax', duMax,...
                'algType', algType);
        end
    end
end
